#!/bin/vbash

: ${vyatta_env:=/etc/default/vyatta}
source $vyatta_env

ENVIRONMENT=""
SSH_KEY=""
SSH_USER="vyos"
USER_DATA=""

CONF_DIR="${vyatta_sysconfdir}/vyos-cloudinit"
. ${CONF_DIR}/vyos-cloudinit.conf

if [ -n "${ENVIRONMENT}" ]; then
  env_conf=${CONF_DIR}/${ENVIRONMENT}.conf
  if [ -f ${env_conf} ]; then
    . ${env_conf}
  else
    echo "${ENVIRONMENT} is not supported"
  fi
fi

# override with user specified parameters
. ${CONF_DIR}/vyos-cloudinit.conf

if [[ -z "${SSH_KEY}" && -z "${USER_DATA}" ]]; then
  echo "both ssh-key and user-data are not specified"
  exit 0
fi

LOAD_KEY="${vyatta_sbindir}/vyatta-load-user-key.pl"
LOAD_CONFIG="${vyatta_sbindir}/vyatta-load-config.pl"

_exit=exit
source ${vyatta_sysconfdir}/functions/script-template

function load_key() {
  echo "loading ssh key..."
  ${LOAD_KEY} ${SSH_USER} ${SSH_KEY}
}

ssh_key_code=0
if [[ -n "${SSH_KEY}" && "${SSH_KEY}" == "http"* ]]; then
  /usr/bin/curl -m 3 -sf "${SSH_KEY}"
  if [ $? -ne 0 ]; then
    echo "could not retrieve ssh key from ${SSH_KEY}"
    ssh_key_code=1
  else
    load_key
    ssh_key_code=$?
  fi
elif [[ -n "${SSH_KEY}" ]]; then
  load_key
  ssh_key_code=$?
fi

if [[ -z "${USER_DATA}" ]]; then
  $_exit ${ssh_key_code}
fi

user_data_code=0
if [[ "${USER_DATA}" == "http"* ]]; then
  tmpdata=$(mktemp /tmp/XXXXXX-user-data)
  /usr/bin/curl -m 3 -sf "${USER_DATA}" -o ${tmpdata}
  if [ $? -ne 0 ]; then
    echo "could not retrieve user-data from ${USER_DATA}"
    user_data_code=1
  fi
  USER_DATA="${tmpdata}"
fi

header=$(head -n1 ${USER_DATA})

if [[ "${header}" == "#vyos-config" ]]; then
  echo "merging VyOS config..."
  tmpconf=$(mktemp /tmp/XXXXXX-config)
  output=$(mktemp /tmp/XXXXXX-output)
  tail -n +2 ${USER_DATA} > ${tmpconf}
  echo Y | python -c 'import pty, sys; pty.spawn(sys.argv[1:])' ${LOAD_CONFIG} ${tmpconf} --merge > ${output}
  result=$(cat ${output} | tail -n +5 | head -n -1)
  grep -q fail ${output}
  user_data_code=$?
  if [ ${user_data_code} -eq 0 ]; then
    echo "merge failed"
    echo "${result}"
    user_data_code=1
  else
    commit
    save
    user_data_code=0
  fi
elif [[ "${header}" == "#!/bin/vbash" ]]; then
  echo "running user script..."
  chmod +x ${USER_DATA}
  result=$(${USER_DATA})
  user_data_code=$?
  if [[ ${user_data_code} -ne 0 ]]; then
    echo "user script failed"
    echo "${result}"
  fi
fi

if [[ ${user_data_code} -eq 0 ]]; then
  rm -f ${tmpdata} ${tmpconf} ${output}
fi

$_exit $code
